@data_exporter
def send_alerts_if_needed(metrics, *args, **kwargs):
    """
    Enviar alertas si el sistema est치 degradado o hay problemas de calidad
    """
    print("Verificando alertas...")
    
    alerts = []
    health_checks = metrics.get('health_checks', {})
    
    # 1. Verificar estado general del sistema
    if metrics['system_status'] != 'healthy':
        degraded_services = metrics.get('degraded_services', [])
        alert_msg = f"SISTEMA DEGRADADO - Servicios afectados: {degraded_services}"
        print(alert_msg)
        alerts.append({
            'type': 'system_degraded',
            'message': alert_msg,
            'severity': 'high'
        })
    
    # 2. Verificar API espec칤ficamente
    if 'api' in health_checks and health_checks['api']['status'] != 'healthy':
        alert_msg = f"游깷 API CA칈DA - {health_checks['api'].get('error', 'No disponible')}"
        print(alert_msg)
        alerts.append({
            'type': 'api_down',
            'message': alert_msg,
            'severity': 'high'
        })
    
    # 3. Verificar calidad de datos
    if 'data_quality' in metrics:
        quality = metrics['data_quality']
        avg_score = quality.get('avg_quality_score', 100)
        total_trips = quality.get('total_trips_last_hour', 0)
        valid_trips = quality.get('valid_trips_last_hour', 0)
        
        # Alerta por calidad baja
        if avg_score < 70:
            alert_msg = f"丘멆잺 CALIDAD DE DATOS BAJA - Score promedio: {avg_score:.1f}"
            print(alert_msg)
            alerts.append({
                'type': 'low_data_quality',
                'message': alert_msg,
                'severity': 'medium',
                'avg_score': avg_score
            })
        
        # Alerta por alta tasa de datos inv치lidos (>20%)
        if total_trips > 0:
            valid_ratio = valid_trips / total_trips
            if valid_ratio < 0.8:
                alert_msg = f"丘멆잺  ALTA TASA DE DATOS INV츼LIDOS - {valid_trips}/{total_trips} v치lidos ({valid_ratio:.1%})"
                print(alert_msg)
                alerts.append({
                    'type': 'high_invalid_data',
                    'message': alert_msg,
                    'severity': 'medium',
                    'valid_ratio': valid_ratio
                })
    
    # 4. Verificar cola SQS saturada
    if 'sqs' in health_checks and health_checks['sqs']['status'] == 'healthy':
        message_count = health_checks['sqs'].get('message_count', 0)
        if message_count > 1000:
            alert_msg = f"游닏 COLA SQS SATURADA - {message_count} mensajes pendientes"
            print(alert_msg)
            alerts.append({
                'type': 'sqs_backlog',
                'message': alert_msg,
                'severity': 'medium',
                'message_count': message_count
            })
    
    # Guardar en S3 (c칩digo anterior...)
    # ... el resto del c칩digo de guardado en S3 permanece igual
    
    return {
        'timestamp': datetime.utcnow().isoformat(),
        'system_status': metrics['system_status'],
        'alert_count': len(alerts),
        'alerts_generated': alerts,
        'summary': f"{len(alerts)} alertas generadas",
        'api_status': health_checks.get('api', {}).get('status', 'unknown')
    }